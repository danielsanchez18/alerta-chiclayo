<section class="grid gap-y-5 p-5">

  <div>
    <h2 class="text-xl font-medium mb-2">Mapa de Seguridad por Zonas</h2>
    <p class="text-sm text-white/60">Analiza el nivel de seguridad en tu zona basado en incidentes reportados</p>
  </div>

  <!-- Controles -->
  <div class="grid gap-y-2">
    <label class="text-sm tracking-wider font-semibold">Radio de an√°lisis:</label>
    <select 
      [(ngModel)]="selectedRadius"
      (ngModelChange)="onRadiusChange($event)"
      class="bg-white/10 text-white text-sm w-full px-5 py-3 rounded-lg border border-white/10 focus:border-primary focus:outline-primary">
      <option class="bg-black/80 text-white" [value]="500">500 metros</option>
      <option class="bg-black/80 text-white" [value]="1000">1 kil√≥metro</option>
      <option class="bg-black/80 text-white" [value]="1500">1.5 kil√≥metros</option>
      <option class="bg-black/80 text-white" [value]="2000">2 kil√≥metros</option>
      <option class="bg-black/80 text-white" [value]="3000">3 kil√≥metros</option>
    </select>
    <p class="text-xs text-white/50">üí° Arrastra el marcador azul para analizar diferentes zonas</p>
  </div>

  <!-- Mapa -->
  <div class="h-[25rem] rounded-xl overflow-hidden relative">
    @if (!mapLoaded()) {
      <div class="flex items-center justify-center h-full bg-white/5">
        <div class="text-center">
          <div class="loader mx-auto mb-3"></div>
          <p class="text-white/60 text-sm">Cargando mapa de seguridad...</p>
        </div>
      </div>
    }
    <div id="zone-safety-map" class="h-full w-full" [class.hidden]="!mapLoaded()"></div>
  </div>

  <!-- An√°lisis de zona -->
  @if (zoneAnalysis()) {
    <div class="space-y-4">
      
      <!-- Nivel de riesgo principal -->
      <div 
        class="flex gap-x-4 px-5 py-4 rounded-xl"
        [style.background-color]="getRiskColor(zoneAnalysis()!.riskLevel) + '20'"
        [style.border]="'2px solid ' + getRiskColor(zoneAnalysis()!.riskLevel)">
        <div class="text-4xl">{{ getRiskIcon(zoneAnalysis()!.riskLevel) }}</div>
        <div class="flex-1">
          <h3 class="text-lg font-bold mb-1" [style.color]="getRiskColor(zoneAnalysis()!.riskLevel)">
            {{ getRiskLevelText(zoneAnalysis()!.riskLevel) }}
          </h3>
          <p class="text-sm text-white/80">
            Nivel de riesgo: {{ zoneAnalysis()!.riskPercentage }}%
          </p>
          <div class="w-full bg-white/10 rounded-full h-2 mt-2">
            <div 
              class="h-2 rounded-full transition-all duration-500"
              [style.width.%]="zoneAnalysis()!.riskPercentage"
              [style.background-color]="getRiskColor(zoneAnalysis()!.riskLevel)">
            </div>
          </div>
        </div>
      </div>

      <!-- Estad√≠sticas -->
      <div class="grid grid-cols-3 gap-3">
        <div class="bg-white/5 rounded-xl p-4 text-center">
          <div class="text-2xl font-bold text-primary">{{ zoneAnalysis()!.totalIncidents }}</div>
          <div class="text-xs text-white/60 mt-1">Total incidentes</div>
        </div>
        <div class="bg-white/5 rounded-xl p-4 text-center">
          <div class="text-2xl font-bold" 
            [class.text-red-400]="zoneAnalysis()!.lastMonth > 5"
            [class.text-yellow-400]="zoneAnalysis()!.lastMonth > 2 && zoneAnalysis()!.lastMonth <= 5"
            [class.text-green-400]="zoneAnalysis()!.lastMonth <= 2">
            {{ zoneAnalysis()!.lastMonth }}
          </div>
          <div class="text-xs text-white/60 mt-1">√öltimo mes</div>
        </div>
        <div class="bg-white/5 rounded-xl p-4 text-center">
          <div class="text-2xl font-bold text-white/80">{{ zoneAnalysis()!.lastThreeMonths }}</div>
          <div class="text-xs text-white/60 mt-1">√öltimos 3 meses</div>
        </div>
      </div>

      <!-- Incidentes por tipo -->
      @if (Object.keys(zoneAnalysis()!.incidentsByType).length > 0) {
        <div class="bg-white/5 rounded-xl p-4">
          <h4 class="font-semibold mb-3">üìà Incidentes por categor√≠a</h4>
          <div class="space-y-2">
            @for (type of Object.keys(zoneAnalysis()!.incidentsByType); track type) {
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <div class="size-2 rounded-full bg-primary"></div>
                  <span class="text-sm">{{ type }}</span>
                </div>
                <span class="text-sm font-semibold text-primary">{{ zoneAnalysis()!.incidentsByType[type] }}</span>
              </div>
            }
          </div>
        </div>
      }

      <!-- Recomendaciones -->
      <div class="bg-white/5 rounded-xl p-4">
        <h4 class="font-semibold mb-3">üõ°Ô∏è Recomendaciones de seguridad</h4>
        <div class="space-y-2">
          @for (recommendation of zoneAnalysis()!.recommendations; track $index) {
            <div class="flex items-start gap-3 text-sm">
              <div class="text-primary shrink-0">‚Ä¢</div>
              <span class="text-white/80">{{ recommendation }}</span>
            </div>
          }
        </div>
      </div>

      <!-- Leyenda del mapa -->
      <div class="bg-white/5 rounded-xl p-4">
        <h4 class="font-semibold mb-3">üìç Leyenda del mapa</h4>
        <div class="grid gap-2 text-xs">
          <div class="flex items-center gap-2">
            <div class="size-3 rounded-full bg-blue-500"></div>
            <span>Tu ubicaci√≥n (arrastra para mover)</span>
          </div>
          <div class="flex items-center gap-2">
            <div class="size-3 rounded-full bg-green-500"></div>
            <span>Incidente leve (1-2)</span>
          </div>
          <div class="flex items-center gap-2">
            <div class="size-3 rounded-full bg-yellow-500"></div>
            <span>Incidente moderado (3)</span>
          </div>
          <div class="flex items-center gap-2">
            <div class="size-3 rounded-full bg-orange-500"></div>
            <span>Incidente grave (4)</span>
          </div>
          <div class="flex items-center gap-2">
            <div class="size-3 rounded-full bg-red-500"></div>
            <span>Incidente muy grave (5)</span>
          </div>
        </div>
      </div>

    </div>
  }

</section>

<style>
  .loader {
    width: 48px;
    height: 48px;
    border: 5px solid;
    border-color: #d5e301 transparent;
    border-radius: 50%;
    display: inline-block;
    box-sizing: border-box;
    animation: rotation 1s linear infinite;
  }

  @keyframes rotation {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
</style>
